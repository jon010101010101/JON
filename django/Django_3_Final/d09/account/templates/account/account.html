{% extends "account/base.html" %}
{% load i18n %}
{% block title %}Account{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="hello-big">{% trans "Account Dashboard" %}</h1>
</div>

{% if user.is_authenticated %}
    <div class="alert alert-success text-center" id="logged-in-box">
        <p>{% trans "Welcome" %}, <strong>{{ user.username }}</strong>!</p>
        <p>{% trans "Here you can manage your account, articles, and favorites." %}</p>
        <a href="{% url 'article_list' %}" class="btn btn-primary btn-lg-custom">{% trans "View Articles" %}</a>
        <a href="{% url 'favourite_list' %}" class="btn btn-secondary btn-lg-custom">{% trans "View Favorites" %}</a>
        <button id="logout-btn" class="btn btn-danger btn-lg-custom">{% trans "Logout" %}</button>
    </div>
{% else %}
    <div id="login-box">
        <form id="ajax-login-form" method="post" class="border p-4 rounded bg-light">
            {% csrf_token %}
            <div class="form-group mb-3">
                <label for="id_username">{% trans "Username" %}</label>
                <input type="text" name="username" id="id_username" class="form-control" required>
            </div>
            <div class="form-group mb-3">
                <label for="id_password">{% trans "Password" %}</label>
                <input type="password" name="password" id="id_password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary btn-lg-custom">{% trans "Login" %}</button>
        </form>
        <div id="login-errors" class="mt-3 text-danger"></div>
        <p class="mt-3">{% trans "Don't have an account?" %} <a href="{% url 'register' %}">{% trans "Register here." %}</a></p>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

$(function(){
    // Handle AJAX login
    $('#ajax-login-form').on('submit', function(e){
        e.preventDefault();
        $.ajax({
            url: "{% url 'ajax_login' %}",
            type: 'POST',
            data: $(this).serialize(),
            headers: {"X-CSRFToken": csrftoken},
            success: function(data){
                if(data.status === 'success'){
                    $('#login-box').html('<div class="alert alert-success text-center">{% trans "Welcome" %}, <strong>' + data.username + '</strong>!<br><button id="logout-btn" class="btn btn-danger btn-lg-custom mt-3">{% trans "Logout" %}</button></div>');
                } else {
                    $('#login-errors').html("{% trans 'Invalid username or password.' %}");
                }
            }
        });
    });

    // Handle AJAX logout
    $(document).on('click', '#logout-btn', function(){
        $.ajax({
            url: "{% url 'ajax_logout' %}",
            type: 'POST',
            headers: {"X-CSRFToken": csrftoken},
            success: function(data){
                if(data.status === 'success'){
                    window.location.href = "{% url 'account' %}";
                }
            }
        });
    });
});
</script>
{% endblock %}