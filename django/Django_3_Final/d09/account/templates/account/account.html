{% extends "account/base.html" %}
{% load i18n %}
{% block title %}Account{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="hello-big">{% trans "Account" %}</h1>
</div>
{% if user.is_authenticated %}
    <div class="alert alert-success text-center" id="logged-in-box">
        <p>{% trans "Welcome" %}, <strong>{{ user.username }}</strong>!</p>
        <button id="logout-btn" class="btn btn-danger btn-lg-custom">{% trans "Logout" %}</button>
    </div>
{% else %}
    <div id="login-box">
        <form id="ajax-login-form" method="post" class="border p-4 rounded bg-light">
            {% csrf_token %}
            <div class="form-group mb-3">
                <label for="id_username">{% trans "Username" %}</label>
                {{ form.username }}
            </div>
            <div class="form-group mb-3">
                <label for="id_password">{% trans "Password" %}</label>
                {{ form.password }}
            </div>
            <button type="submit" class="btn btn-primary btn-lg-custom">{% trans "Login" %}</button>
        </form>
        <div id="login-errors" class="mt-3 text-danger"></div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

$(function(){
    $('#ajax-login-form').on('submit', function(e){
        e.preventDefault();
        $.ajax({
            url: "{% url 'ajax_login' %}",
            type: 'POST',
            data: $(this).serialize(),
            headers: {"X-CSRFToken": csrftoken},
            success: function(data){
                if(data.success){
                    $('#login-box').html('<div class="alert alert-success text-center">{% trans "Welcome" %}, <strong>' + data.username + '</strong>!<br><button id="logout-btn" class="btn btn-danger btn-lg-custom mt-3">{% trans "Logout" %}</button></div>');
                } else {
                    let errors = "";
                    $.each(data.errors, function(key, value){
                        errors += value + "<br>";
                    });
                    $('#login-errors').html(errors);
                }
            }
        });
    });

    $(document).on('click', '#logout-btn', function(){
        $.ajax({
            url: "{% url 'ajax_logout' %}",
            type: 'POST',
            headers: {"X-CSRFToken": csrftoken},
            success: function(data){
                if(data.success){
                    location.reload();
                }
            }
        });
    });
});
</script>
{% endblock %}
